<!DOCTYPE html>
<html lang="pt-BR" class="dark antialiased">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TaskFlow | Login</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Plus Jakarta Sans', 'sans-serif'] },
                    colors: {
                        background: '#020617',
                        surface: '#0f172a',
                        surfaceHighlight: '#1e293b',
                        primary: { 400: '#60a5fa', 500: '#3b82f6', 600: '#2563eb', 700: '#1d4ed8', glow: 'rgba(59, 130, 246, 0.5)' }
                    },
                    boxShadow: { 'neon': '0 0 20px rgba(59, 130, 246, 0.2)' }
                }
            }
        }
    </script>
    <style>
        body { background-color: #020617; color: #f8fafc; }
        .hidden-screen { display: none !important; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.4s ease-out; }
        
        .checkbox-wrapper input:checked + div { background-color: #3b82f6; border-color: #3b82f6; }
        .checkbox-wrapper input:checked + div svg { display: block; }
        .modern-select { appearance: none; background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%2394a3b8' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e"); background-position: right 0.75rem center; background-repeat: no-repeat; background-size: 1.5em 1.5em; }
        dialog::backdrop { background: rgba(2, 6, 23, 0.8); backdrop-filter: blur(8px); }
        .nav-btn.active { background: linear-gradient(90deg, rgba(59, 130, 246, 0.1) 0%, transparent 100%); border-left: 3px solid #3b82f6; color: #60a5fa; }
    </style>
</head>
<body class="h-screen overflow-hidden selection:bg-primary-500 selection:text-white relative">

    <!-- ================= AUTH SCREEN ================= -->
    <div id="auth-screen" class="absolute inset-0 z-50 flex items-center justify-center bg-[#020617] bg-[radial-gradient(ellipse_at_center,_var(--tw-gradient-stops))] from-blue-900/20 via-background to-background">
        <div class="w-full max-w-md p-8 animate-fade-in">
            <div class="flex justify-center mb-8">
                <div class="relative group">
                    <div class="absolute -inset-2 bg-gradient-to-r from-blue-600 to-cyan-600 rounded-2xl blur opacity-30 group-hover:opacity-75 transition duration-500"></div>
                    <div class="relative w-16 h-16 bg-surface rounded-2xl flex items-center justify-center text-primary-500 border border-surfaceHighlight shadow-neon">
                        <i class="ph-fill ph-check-square-offset text-4xl"></i>
                    </div>
                </div>
            </div>
            
            <h2 class="text-3xl font-bold text-center text-white mb-2" id="auth-title">Bem-vindo de volta</h2>
            <p class="text-center text-slate-400 mb-8" id="auth-subtitle">Faça login para acessar suas tarefas</p>

            <form id="auth-form" class="space-y-5">
                <div id="name-field" class="hidden">
                    <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Nome</label>
                    <input type="text" id="input-name" class="w-full bg-surface border border-surfaceHighlight rounded-xl px-5 py-3.5 text-white placeholder-slate-600 focus:ring-2 focus:ring-primary-500 focus:outline-none transition-all" placeholder="Seu nome">
                </div>

                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Email</label>
                    <input type="email" id="input-email" required class="w-full bg-surface border border-surfaceHighlight rounded-xl px-5 py-3.5 text-white placeholder-slate-600 focus:ring-2 focus:ring-primary-500 focus:outline-none transition-all" placeholder="seu@email.com">
                </div>
                
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Senha</label>
                    <input type="password" id="input-password" required class="w-full bg-surface border border-surfaceHighlight rounded-xl px-5 py-3.5 text-white placeholder-slate-600 focus:ring-2 focus:ring-primary-500 focus:outline-none transition-all" placeholder="••••••••">
                </div>

                <button type="submit" class="w-full py-4 rounded-xl bg-primary-600 hover:bg-primary-500 text-white font-bold shadow-lg shadow-primary-600/20 transition-all transform hover:-translate-y-0.5 active:translate-y-0 flex items-center justify-center gap-2">
                    <span id="btn-text">Entrar</span>
                    <i class="ph-bold ph-arrow-right"></i>
                </button>
            </form>

            <div class="mt-8 text-center text-sm">
                <p class="text-slate-500">
                    <span id="switch-text">Não tem uma conta?</span>
                    <button onclick="toggleAuthMode()" class="text-primary-400 hover:text-white font-bold ml-1 transition-colors underline decoration-transparent hover:decoration-primary-400 underline-offset-4">
                        <span id="switch-btn">Criar conta</span>
                    </button>
                </p>
                <div id="auth-error" class="mt-4 text-red-400 text-xs font-bold hidden bg-red-900/20 p-2 rounded-lg"></div>
            </div>
        </div>
    </div>

    <!-- ================= DASHBOARD SCREEN ================= -->
    <div id="dashboard-screen" class="hidden-screen flex w-full h-full">
        <!-- SIDEBAR -->
        <aside class="w-20 lg:w-64 flex-shrink-0 bg-surface border-r border-surfaceHighlight flex flex-col z-20 shadow-2xl">
            <div class="h-24 flex items-center justify-center lg:justify-start lg:px-8 border-b border-surfaceHighlight">
                <div class="w-10 h-10 bg-primary-600 rounded-xl flex items-center justify-center text-white">
                    <i class="ph-fill ph-check-square-offset text-2xl"></i>
                </div>
                <span class="ml-4 font-bold text-xl hidden lg:block tracking-tight text-white">TaskFlow</span>
            </div>

            <nav class="flex-1 py-8 px-4 space-y-2 overflow-y-auto">
                <button onclick="filterTasks('all')" id="nav-all" class="nav-btn w-full flex items-center p-3 rounded-lg text-slate-400 hover:text-white hover:bg-surfaceHighlight transition-all duration-200 group active">
                    <i class="ph ph-squares-four text-xl"></i>
                    <span class="ml-3 hidden lg:block font-medium">Dashboard</span>
                </button>
                <button onclick="filterTasks('today')" id="nav-today" class="nav-btn w-full flex items-center p-3 rounded-lg text-slate-400 hover:text-white hover:bg-surfaceHighlight transition-all duration-200 group">
                    <i class="ph ph-sun text-xl"></i>
                    <span class="ml-3 hidden lg:block font-medium">Meu Dia</span>
                </button>
                <button onclick="filterTasks('important')" id="nav-important" class="nav-btn w-full flex items-center p-3 rounded-lg text-slate-400 hover:text-white hover:bg-surfaceHighlight transition-all duration-200 group">
                    <i class="ph ph-star text-xl"></i>
                    <span class="ml-3 hidden lg:block font-medium">Importante</span>
                </button>

                <div class="pt-8 pb-3 px-3 hidden lg:block">
                    <p class="text-[11px] font-bold text-slate-500 uppercase tracking-widest">Opções</p>
                </div>
                <button onclick="logout()" class="nav-btn w-full flex items-center p-3 rounded-lg text-red-400 hover:bg-red-900/20 transition-all duration-200">
                    <i class="ph ph-sign-out text-xl"></i>
                    <span class="ml-3 hidden lg:block font-medium">Sair</span>
                </button>
            </nav>
        </aside>

        <!-- MAIN CONTENT -->
        <main class="flex-1 flex flex-col h-screen overflow-hidden relative bg-background bg-[radial-gradient(ellipse_at_top_right,_var(--tw-gradient-stops))] from-blue-900/10 via-background to-background">
            <div class="flex-1 overflow-y-auto p-4 lg:p-10 scroll-smooth">
                <div class="max-w-5xl mx-auto w-full">
                    
                    <header class="mb-10">
                        <div class="flex flex-col md:flex-row md:items-end justify-between gap-4 mb-4">
                            <div>
                                <h1 class="text-3xl lg:text-4xl font-bold mb-2 text-white tracking-tight" id="greeting">Olá...</h1>
                                <p class="text-slate-400 flex items-center font-medium">
                                    <i class="ph ph-calendar-blank mr-2 text-primary-500"></i>
                                    <span id="date-display">Carregando data...</span>
                                </p>
                            </div>
                        </div>
                        <!-- FRASE MOTIVACIONAL RÚSTICA -->
                        <div class="bg-surfaceHighlight/50 border-l-4 border-primary-500 p-4 rounded-r-xl">
                            <p class="text-sm font-bold text-slate-300 italic uppercase tracking-wider" id="brutal-quote">
                                "Carregando a dose de realidade..."
                            </p>
                        </div>
                    </header>

                    <!-- Stats Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-5 mb-12">
                        <div class="bg-surface p-6 rounded-2xl border border-surfaceHighlight flex items-center justify-between">
                            <div>
                                <p class="text-sm text-slate-400 font-medium">Tarefas Totais</p>
                                <h3 class="text-3xl font-bold mt-2 text-white" id="stat-total">0</h3>
                            </div>
                            <div class="w-12 h-12 bg-surfaceHighlight rounded-xl flex items-center justify-center text-2xl text-blue-400"><i class="ph ph-stack"></i></div>
                        </div>
                        <div class="bg-surface p-6 rounded-2xl border border-surfaceHighlight flex items-center justify-between">
                            <div>
                                <p class="text-sm text-slate-400 font-medium">Pendentes</p>
                                <h3 class="text-3xl font-bold mt-2 text-white" id="stat-pending">0</h3>
                            </div>
                            <div class="w-12 h-12 bg-surfaceHighlight rounded-xl flex items-center justify-center text-2xl text-orange-400"><i class="ph ph-hourglass"></i></div>
                        </div>
                        <div class="bg-surface p-6 rounded-2xl border border-surfaceHighlight flex items-center justify-between">
                            <div>
                                <p class="text-sm text-slate-400 font-medium">Concluídas</p>
                                <h3 class="text-3xl font-bold mt-2 text-white" id="stat-completed">0</h3>
                            </div>
                            <div class="w-12 h-12 bg-surfaceHighlight rounded-xl flex items-center justify-center text-2xl text-emerald-400"><i class="ph ph-check-circle"></i></div>
                        </div>
                    </div>

                    <!-- Search Filter -->
                    <div class="flex flex-col md:flex-row md:items-center justify-between gap-5 mb-8">
                        <h2 class="text-2xl font-bold flex items-center gap-3 text-white">
                            <span id="current-view-title">Dashboard</span>
                            <span class="text-xs px-2.5 py-1 bg-surfaceHighlight border border-slate-700 rounded-md text-primary-400 font-mono" id="task-count-badge">0</span>
                        </h2>
                        <div class="relative flex items-center bg-surface border border-surfaceHighlight rounded-xl overflow-hidden">
                            <i class="ph ph-magnifying-glass absolute left-4 text-slate-500"></i>
                            <input type="text" id="search-input" placeholder="Pesquisar tarefa..." class="pl-11 pr-4 py-3 bg-transparent text-sm text-white placeholder-slate-500 focus:outline-none w-full md:w-72">
                        </div>
                    </div>

                    <div id="task-list" class="space-y-4 pb-32">
                        <!-- Tasks Injected Here -->
                    </div>

                    <div id="empty-state" class="hidden flex-col items-center justify-center py-20 text-center">
                        <div class="w-24 h-24 bg-surfaceHighlight rounded-full flex items-center justify-center mb-6">
                            <i class="ph ph-sparkle text-4xl text-slate-600"></i>
                        </div>
                        <h3 class="text-xl font-bold text-white mb-2">Tudo tranquilo!</h3>
                        <p class="text-slate-500 max-w-xs mx-auto">Você não tem tarefas pendentes.</p>
                    </div>
                </div>
            </div>

            <button onclick="openCreateModal()" id="open-modal-btn" class="absolute bottom-10 right-10 group z-30">
                <div class="absolute inset-0 bg-blue-500 rounded-full blur opacity-40 group-hover:opacity-60 transition-opacity duration-300"></div>
                <div class="relative bg-primary-600 hover:bg-primary-500 text-white w-16 h-16 rounded-full flex items-center justify-center shadow-2xl transition-all transform hover:scale-105 active:scale-95 border border-white/10">
                    <i class="ph ph-plus text-3xl font-bold"></i>
                </div>
            </button>
        </main>
    </div>

    <!-- MODAL DE TAREFA (Criar e Editar) -->
    <dialog id="task-modal" class="bg-transparent p-0 w-full max-w-lg backdrop:bg-black/80">
        <div class="bg-surface rounded-3xl shadow-2xl overflow-hidden border border-surfaceHighlight relative">
            <div class="absolute top-0 left-0 right-0 h-1 bg-gradient-to-r from-blue-600 via-cyan-500 to-blue-600"></div>
            <div class="p-8">
                <div class="flex justify-between items-start mb-8">
                    <h3 class="text-2xl font-bold text-white" id="modal-header-title">Nova Tarefa</h3>
                    <button id="close-modal-btn" class="text-slate-500 hover:text-white"><i class="ph ph-x text-xl"></i></button>
                </div>
                <form id="task-form" class="space-y-6">
                    <div class="space-y-2">
                        <label class="block text-xs font-bold text-blue-400 uppercase tracking-wider">Título</label>
                        <input type="text" id="modal-title" required class="w-full bg-background border border-surfaceHighlight rounded-xl px-5 py-4 text-white focus:outline-none focus:border-primary-500" placeholder="Ex: Dominar o mundo...">
                    </div>
                    <div class="grid grid-cols-2 gap-6">
                        <div class="space-y-2">
                            <label class="block text-xs font-bold text-slate-500 uppercase">Categoria</label>
                            <select id="modal-category" class="modern-select w-full bg-background border border-surfaceHighlight rounded-xl pl-5 pr-10 py-3.5 text-sm text-slate-300 focus:outline-none">
                                <option value="Trabalho">Trabalho</option>
                                <option value="Pessoal">Pessoal</option>
                                <option value="Estudos">Estudos</option>
                            </select>
                        </div>
                        <div class="space-y-2">
                            <label class="block text-xs font-bold text-slate-500 uppercase">Prioridade</label>
                            <select id="modal-priority" class="modern-select w-full bg-background border border-surfaceHighlight rounded-xl pl-5 pr-10 py-3.5 text-sm text-slate-300 focus:outline-none">
                                <option value="low">Baixa</option>
                                <option value="medium">Média</option>
                                <option value="high">Alta</option>
                            </select>
                        </div>
                    </div>
                    <div class="space-y-2">
                        <label class="block text-xs font-bold text-slate-500 uppercase">Vencimento (Prazo)</label>
                        <input type="date" id="modal-date" class="w-full bg-background border border-surfaceHighlight rounded-xl px-5 py-3.5 text-slate-300 focus:outline-none [color-scheme:dark]">
                    </div>
                    <div class="pt-6 flex gap-4">
                        <button type="button" id="cancel-btn" class="flex-1 py-3.5 rounded-xl border border-surfaceHighlight text-slate-400 hover:text-white">Cancelar</button>
                        <button type="submit" class="flex-1 py-3.5 rounded-xl bg-primary-600 hover:bg-primary-500 text-white font-bold" id="modal-submit-btn">Salvar</button>
                    </div>
                </form>
            </div>
        </div>
    </dialog>

    <script>
        const API_URL = 'http://localhost:5000';
        let currentUser = JSON.parse(localStorage.getItem('taskflow_user')) || null;
        let tasks = [];
        let currentFilter = 'all';
        let isLoginMode = true;
        let editingTaskId = null; // Variável para controlar se estamos editando

        // --- MOTIVATIONAL QUOTES (RÚSTICAS) ---
        const quotes = [
            "VAI CHORAR OU VAI FAZER?",
            "O MUNDO NÃO TE DEVE NADA. CORRA ATRÁS.",
            "DESCANSO É PARA QUEM TERMINOU.",
            "SUA DESCULPA É INVÁLIDA. TRABALHE.",
            "DOR É TEMPORÁRIA. A GLÓRIA É ETERNA.",
            "NINGUÉM VAI FAZER POR VOCÊ. LEVANTA E FAZ.",
            "SEJA MAIS FORTE QUE SUA MELHOR DESCULPA.",
            "RESULTADOS, NÃO DESCULPAS.",
            "ENQUANTO VOCÊ DORME, O ADVERSÁRIO TREINA.",
            "DISCIPLINA É FAZER O QUE TEM QUE SER FEITO, MESMO SEM VONTADE."
        ];

        function setRandomQuote() {
            const index = Math.floor(Math.random() * quotes.length);
            document.getElementById('brutal-quote').textContent = `"${quotes[index]}"`;
        }

        // --- AUTH LOGIC ---
        function checkAuth() {
            if (currentUser) {
                document.getElementById('auth-screen').classList.add('hidden-screen');
                document.getElementById('dashboard-screen').classList.remove('hidden-screen');
                initDashboard();
            } else {
                document.getElementById('auth-screen').classList.remove('hidden-screen');
                document.getElementById('dashboard-screen').classList.add('hidden-screen');
            }
        }

        function toggleAuthMode() {
            isLoginMode = !isLoginMode;
            const title = document.getElementById('auth-title');
            const subtitle = document.getElementById('auth-subtitle');
            const nameField = document.getElementById('name-field');
            const btnText = document.getElementById('btn-text');
            const switchText = document.getElementById('switch-text');
            const switchBtn = document.getElementById('switch-btn');
            const errorDiv = document.getElementById('auth-error');

            errorDiv.classList.add('hidden');

            if (isLoginMode) {
                title.textContent = 'Bem-vindo de volta';
                subtitle.textContent = 'Faça login para acessar suas tarefas';
                nameField.classList.add('hidden');
                document.getElementById('input-name').required = false;
                btnText.textContent = 'Entrar';
                switchText.textContent = 'Não tem uma conta?';
                switchBtn.textContent = 'Criar conta';
            } else {
                title.textContent = 'Crie sua conta';
                subtitle.textContent = 'Comece a organizar sua vida hoje';
                nameField.classList.remove('hidden');
                document.getElementById('input-name').required = true;
                btnText.textContent = 'Cadastrar';
                switchText.textContent = 'Já tem uma conta?';
                switchBtn.textContent = 'Fazer Login';
            }
        }

        async function handleAuth(e) {
            e.preventDefault();
            const email = document.getElementById('input-email').value;
            const password = document.getElementById('input-password').value;
            const name = document.getElementById('input-name').value;
            const errorDiv = document.getElementById('auth-error');
            errorDiv.classList.add('hidden');

            const endpoint = isLoginMode ? '/login' : '/register';
            const body = isLoginMode ? { email, password } : { name, email, password };

            try {
                const res = await fetch(`${API_URL}${endpoint}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                const data = await res.json();

                if (res.ok) {
                    if (isLoginMode) {
                        currentUser = data.user;
                        localStorage.setItem('taskflow_user', JSON.stringify(currentUser));
                        checkAuth();
                    } else {
                        alert('Conta criada! Faça login.');
                        toggleAuthMode();
                    }
                } else {
                    errorDiv.textContent = data.error || 'Ocorreu um erro.';
                    errorDiv.classList.remove('hidden');
                }
            } catch (err) {
                errorDiv.textContent = 'Erro de conexão com o servidor.';
                errorDiv.classList.remove('hidden');
            }
        }

        function logout() {
            localStorage.removeItem('taskflow_user');
            currentUser = null;
            location.reload();
        }

        // --- DASHBOARD LOGIC ---
        function setGreeting() {
            const hour = new Date().getHours();
            let greeting = hour < 12 ? 'Bom dia' : hour < 18 ? 'Boa tarde' : 'Boa noite';
            if(currentUser) {
                document.getElementById('greeting').textContent = `${greeting}, ${currentUser.name.split(' ')[0]}`;
            }
        }

        function updateDate() {
            const options = { weekday: 'long', day: 'numeric', month: 'long' };
            const date = new Date().toLocaleDateString('pt-BR', options);
            document.getElementById('date-display').textContent = date.charAt(0).toUpperCase() + date.slice(1);
        }

        async function fetchTasks() {
            if(!currentUser) return;
            try {
                const response = await fetch(`${API_URL}/tasks?user_id=${currentUser.id}`);
                if(response.ok) {
                    tasks = await response.json();
                    renderTasks();
                }
            } catch (error) { console.error('Erro ao buscar tarefas'); }
        }

        async function createTask(task) {
            try {
                task.user_id = currentUser.id;
                await fetch(`${API_URL}/tasks`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(task)
                });
                fetchTasks();
            } catch (error) { console.error(error); }
        }

        async function updateTaskContent(id, taskData) {
            try {
                await fetch(`${API_URL}/tasks/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(taskData)
                });
                fetchTasks();
            } catch (error) { console.error(error); }
        }

        async function toggleTaskAPI(id, currentStatus) {
            try {
                await fetch(`${API_URL}/tasks/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ completed: !currentStatus })
                });
                fetchTasks();
            } catch (error) { console.error(error); }
        }

        async function deleteTaskAPI(id) {
            try {
                await fetch(`${API_URL}/tasks/${id}`, { method: 'DELETE' });
                fetchTasks();
            } catch (error) { console.error(error); }
        }

        // --- MODAL & EDIT FUNCTIONS ---

        function openCreateModal() {
            editingTaskId = null;
            document.getElementById('modal-header-title').textContent = "Nova Tarefa";
            document.getElementById('modal-submit-btn').textContent = "Salvar";
            document.getElementById('task-form').reset();
            document.getElementById('modal-date').valueAsDate = new Date();
            document.getElementById('task-modal').showModal();
        }

        function openEditModal(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;

            editingTaskId = taskId;
            document.getElementById('modal-header-title').textContent = "Editar Tarefa";
            document.getElementById('modal-submit-btn').textContent = "Atualizar";
            
            // Preencher campos
            document.getElementById('modal-title').value = task.title;
            document.getElementById('modal-category').value = task.category;
            document.getElementById('modal-priority').value = task.priority;
            document.getElementById('modal-date').value = task.due_date ? task.due_date : '';
            
            document.getElementById('task-modal').showModal();
        }

        // --- RENDER ---
        function renderTasks() {
            const list = document.getElementById('task-list');
            list.innerHTML = '';
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            const todayStr = new Date().toISOString().split('T')[0];

            let filtered = tasks.filter(t => t.title.toLowerCase().includes(searchTerm));

            if (currentFilter === 'today') {
                filtered = filtered.filter(t => t.due_date === todayStr && !t.completed);
            } else if (currentFilter === 'important') {
                filtered = filtered.filter(t => t.priority === 'high' && !t.completed);
            }
            
            filtered.sort((a, b) => Number(a.completed) - Number(b.completed));

            // Stats Update
            document.getElementById('stat-total').textContent = tasks.length;
            document.getElementById('stat-pending').textContent = tasks.filter(t => !t.completed).length;
            document.getElementById('stat-completed').textContent = tasks.filter(t => t.completed).length;
            document.getElementById('task-count-badge').textContent = filtered.length;

            if (filtered.length === 0) {
                document.getElementById('empty-state').classList.remove('hidden');
                document.getElementById('empty-state').classList.add('flex');
            } else {
                document.getElementById('empty-state').classList.add('hidden');
                document.getElementById('empty-state').classList.remove('flex');
            }

            filtered.forEach(task => {
                const priorityStyles = {
                    'low': 'text-blue-400 bg-blue-400/10 border-blue-400/20',
                    'medium': 'text-orange-400 bg-orange-400/10 border-orange-400/20',
                    'high': 'text-red-400 bg-red-400/10 border-red-400/20'
                };
                const dateDisplay = task.due_date ? new Date(task.due_date + 'T00:00:00').toLocaleDateString('pt-BR', {day: '2-digit', month: 'short'}) : '';

                const el = document.createElement('div');
                el.className = `group bg-surface hover:bg-[#162032] p-4 rounded-xl border ${task.completed ? 'border-transparent opacity-50' : 'border-surfaceHighlight'} transition-all flex items-center gap-4 relative overflow-hidden`;
                el.innerHTML = `
                    <label class="checkbox-wrapper relative flex items-center cursor-pointer ml-2">
                        <input type="checkbox" class="sr-only peer" ${task.completed ? 'checked' : ''} onchange="toggleTaskAPI(${task.id}, ${task.completed})">
                        <div class="w-6 h-6 border-2 border-slate-600 rounded-lg transition-all flex items-center justify-center hover:border-blue-500 bg-background">
                            <svg class="hidden w-3.5 h-3.5 text-white pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>
                        </div>
                    </label>
                    <div class="flex-1 cursor-pointer py-1" onclick="toggleTaskAPI(${task.id}, ${task.completed})">
                        <h4 class="font-medium text-slate-200 text-lg ${task.completed ? 'line-through text-slate-500' : ''}">${task.title}</h4>
                        <div class="flex flex-wrap items-center gap-3 mt-2">
                            <span class="text-xs font-semibold text-slate-400">${task.category}</span>
                            <span class="text-[10px] font-bold px-2 py-0.5 rounded border ${priorityStyles[task.priority]}">${task.priority.toUpperCase()}</span>
                            ${task.due_date ? `<span class="text-[11px] font-medium px-2 py-0.5 rounded flex items-center gap-1 text-slate-400 bg-surfaceHighlight"><i class="ph ph-calendar"></i> ${dateDisplay}</span>` : ''}
                        </div>
                    </div>
                    
                    <div class="flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                        <button onclick="openEditModal(${task.id})" class="w-8 h-8 flex items-center justify-center rounded-lg text-slate-500 hover:text-blue-400 hover:bg-blue-900/10 transition-colors" title="Editar">
                            <i class="ph ph-pencil-simple text-lg"></i>
                        </button>
                        <button onclick="deleteTaskAPI(${task.id})" class="w-8 h-8 flex items-center justify-center rounded-lg text-slate-500 hover:text-red-400 hover:bg-red-900/10 transition-colors" title="Deletar">
                            <i class="ph ph-trash text-lg"></i>
                        </button>
                    </div>
                `;
                list.appendChild(el);
            });
        }

        // --- EVENTS ---
        document.getElementById('auth-form').addEventListener('submit', handleAuth);
        
        document.getElementById('task-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const taskData = {
                title: document.getElementById('modal-title').value,
                category: document.getElementById('modal-category').value,
                priority: document.getElementById('modal-priority').value,
                due_date: document.getElementById('modal-date').value
            };

            if (editingTaskId) {
                // MODO EDIÇÃO
                await updateTaskContent(editingTaskId, taskData);
            } else {
                // MODO CRIAÇÃO
                await createTask(taskData);
            }
            
            e.target.reset();
            document.getElementById('task-modal').close();
        });

        document.getElementById('close-modal-btn').addEventListener('click', () => document.getElementById('task-modal').close());
        document.getElementById('cancel-btn').addEventListener('click', () => document.getElementById('task-modal').close());
        document.getElementById('search-input').addEventListener('input', renderTasks);
        
        window.filterTasks = (filter) => { currentFilter = filter; renderTasks(); }

        // --- INIT ---
        function initDashboard() {
            setGreeting();
            updateDate();
            setRandomQuote(); // Define frase motivacional
            fetchTasks();
        }

        checkAuth();

    </script>
</body>
</html>